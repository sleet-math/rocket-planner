<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rocket Planner â€” ã‚·ãƒ³ãƒ—ãƒ«ãƒ¯ã‚¤ãƒ‰UI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg:#ffffff; --muted:#6b7280; --accent:#2563eb; --card:#ffffff;
      --sidebar-w:260px; --inspector-w:320px;
      --border: rgba(2,6,23,0.10);
      /* å®Œäº†ã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è‰² */
      --project-done-bg: #ecfdf5; /* è–„ã„ç·‘ã®èƒŒæ™¯ */
      --project-done-text: #065f46; /* æ¿ƒã„ç·‘ã®æ–‡å­— */
      /* æœŸé™åˆ‡ã‚Œã®ã‚«ãƒ¼ãƒ‰ã®è‰² */
      --deadline-missed-border: #f87171; /* èµ¤ã„æ  */
      --deadline-missed-shadow: rgba(248, 113, 113, 0.2); /* èµ¤ã„å½± */
      /* æ–°ã—ã„ãƒ­ã‚´ã®è‰² */
      --logo-color-start: #a855f7; /* VIOLET-600 */
      --logo-color-end: #ec4899; /* PINK-500 */
    }
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;margin:24px;background:var(--bg);}

    .app{width:calc(100% - 96px);max-width:1400px;margin:0 auto;border-radius:12px;background:linear-gradient(180deg,#ffffff,#ffffff);box-shadow:0 24px 48px rgba(2,6,23,0.06);overflow:hidden;border:1px solid var(--border)}

    /* æ¨ªæ›¸ãã‚’å¼·åˆ¶ï¼ˆç¸¦çµ„ã¿é˜²æ­¢ï¼‰ */
    html, body, .app, .workspace, .sidebar, .content, .inspector, .card, .message, .sb-item, .project-title, .project-sub, .title, h2, input, textarea, select, button {
      writing-mode: horizontal-tb !important;
      -webkit-writing-mode: horizontal-tb !important;
      text-orientation: mixed !important;
      -webkit-text-orientation: mixed !important;
    }

    .titlebar{height:56px;display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-bottom:1px solid var(--border);}
    .brand{display:flex;align-items:center;gap:14px}
    
    /* ğŸš€æ–°ã—ã„ãƒ­ã‚´ã‚¹ã‚¿ã‚¤ãƒ« */
    .logo{
        width:36px;height:36px;border-radius:8px;
        background:linear-gradient(135deg, var(--logo-color-start), var(--logo-color-end));
        display:flex;align-items:center;justify-content:center;
        color:white;font-size:20px;
    }
    .title{font-weight:700}

    .toolbar{display:flex;align-items:center;gap:8px}

    /* content ã« flex-direction: column ã‚’è¿½åŠ ã—ã¦ã€ä¸‹éƒ¨ã«é…ç½®ã—ã‚„ã™ãã™ã‚‹ */
    .workspace{display:flex;min-height:680px}
    .sidebar{width:var(--sidebar-w);padding:20px;border-right:1px solid var(--border);background:transparent;min-width:0;display:flex;flex-direction:column}
    .content{flex:1;padding:24px;min-width:0; display:flex; flex-direction:column; }
    .inspector{width:var(--inspector-w);padding:20px;border-left:1px solid var(--border);background:transparent;min-width:0}

    .sb-item{display:flex;align-items:center;gap:10px;padding:12px;border-radius:10px;cursor:pointer;min-width:0}
    .sb-item:hover{background:rgba(2,6,23,0.03)}
    .sb-item.active{background:linear-gradient(90deg, rgba(99,102,241,0.06), rgba(99,102,241,0.02));}

    .sb-item .project-title{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block;min-width:0}
    .sb-item .project-sub{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:12px;color:var(--muted)}
    
    /* ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œäº†æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« (é …ç›®å…¨ä½“ã®è‰²å¤‰æ›´) */
    .sb-item.done {
      background: var(--project-done-bg); /* èƒŒæ™¯è‰² */
    }
    .sb-item.done .project-title{
      color: var(--project-done-text); /* æ–‡å­—è‰² */
      font-weight: 700;
    }

    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 14px 36px rgba(2,6,23,0.06);border:1px solid rgba(2,6,23,0.06);min-width:0}
    
    /* æœŸé™åˆ‡ã‚Œã®ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
    .card.missed-deadline {
      border: 2px solid var(--deadline-missed-border); /* æ ã‚’èµ¤ã */
      box-shadow: 0 14px 36px var(--deadline-missed-shadow); /* å½±ã‚’èµ¤ã£ã½ã */
    }
    
    /* ğŸš€ å®Œäº†ã—ãŸã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« (æ–‡å­—è‰²å«ã‚€å…¨ä½“å¤‰æ›´) */
    .card.done-card {
        background: #f0fdf4; /* è–„ã„ç·‘ã®èƒŒæ™¯ */
        border: 1px solid #34d399; /* ç·‘ã®æ ç·š */
        opacity: 1.0;
        color: #166534; /* ã‚«ãƒ¼ãƒ‰å…¨ä½“ã®æ¨™æº–æ–‡å­—è‰²ã‚’æ¿ƒã„ç·‘ã«è¨­å®š */
    }
    /* å®Œäº†ã—ãŸã‚«ãƒ¼ãƒ‰å†…ã® muted ãªè¦ç´ ã‚‚ç·‘è‰²ã«èª¿æ•´ */
    .card.done-card .muted {
        color: #34d399 !important;
    }
    /* å®Œäº†ã—ãŸã‚«ãƒ¼ãƒ‰å†…ã®å®Œäº†ãƒœã‚¿ãƒ³ã®è‰²ã¯å…ƒã€…æ¿ƒã„ç·‘ãªã®ã§ç¶­æŒ */

    .muted{color:var(--muted)}
    .pill{padding:8px 12px;border-radius:999px;background:rgba(2,6,23,0.04);font-weight:600}
    .badge{font-weight:700;padding:6px 10px;border-radius:999px;font-size:12px}
    .badge-high{background:#fee2e2;color:#7f1d1d}
    .badge-med{background:#fffbeb;color:#92400e}
    .badge-low{background:#f0fdf4;color:#166534}

    /* .sidebar .filters{margin-top:auto} ã¯å‰Šé™¤ï¼ˆãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ç§»å‹•ã—ãŸãŸã‚ï¼‰ */

    /* å°ç›®æ¨™è¿½åŠ ã‚¨ãƒªã‚¢ã®å¢ƒç•Œ */
    .add-box{border:1px solid var(--border);border-radius:10px;padding:12px;background:linear-gradient(180deg,#ffffff,#fcfcff);box-shadow:0 6px 18px rgba(2,6,23,0.03);display:flex;align-items:center;gap:10px}

    /* æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¨é…ç½®èª¿æ•´ */
    .search-box{
        margin-bottom:0; /* è¦ªè¦ç´ ã§ãƒãƒ¼ã‚¸ãƒ³ã‚’èª¿æ•´ */
        margin-top:0;
        border:1px solid rgba(2,6,23,0.04);padding:8px;border-radius:8px;
        display:flex;align-items:center;gap:8px;min-width:0
    }

    /* ã‚¤ãƒ³ã‚¹ãƒšã‚¯ã‚¿ã®èª¬æ˜ç·¨é›†æ¬„ã‚’ç›®ç«‹ãŸã›ã‚‹ */
    .ins-textarea{width:100%;height:110px;padding:12px;border-radius:8px;border:1px solid var(--border);background:#fff;box-shadow:inset 0 1px 3px rgba(2,6,23,0.02);resize:vertical}

    /* ã‚«ãƒ¼ãƒ‰å†…ã®çŸ­ã„èª¬æ˜ç·¨é›†ï¼ˆã‚‚ã—å°†æ¥å…¥ã‚Œã‚‹å ´åˆï¼‰ã®æ  */
    .card-desc-edit{padding:10px;border-radius:8px;border:1px dashed rgba(2,6,23,0.06);background:rgba(250,250,250,0.6)}

    h2{margin:0 0 6px 0}

    /* å®Œäº†ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .pill.done-button{
        background:#d1fae5; 
        color:#065f46; 
        font-weight:700;
    }
    .pill.not-done-button{
        background:rgba(2,6,23,0.04); 
        color:#374151; /* æ–‡å­—ã‚’æ¿ƒãä¿®æ­£ */
        font-weight:600;
    }
    
    /* ã‚«ãƒ¼ãƒ‰å†…ã®ãƒœã‚¿ãƒ³ã‚’åŒã˜è¡Œã«ç¶­æŒã™ã‚‹ flex ã‚³ãƒ³ãƒ†ãƒŠ */
    .card-actions {
        display: flex;
        align-items: center;
        gap: 6px; /* ãƒœã‚¿ãƒ³é–“ã®é–“éš”ã‚’èª¿æ•´ */
    }


    @media (max-width:1200px){ .app{width:calc(100% - 32px)} .inspector{display:none} }
  </style>
</head>
<body>
  <div class="app" id="appRoot">
    <div class="titlebar">
      <div class="brand">
        <div class="logo">ğŸš€</div>
        <div>
          <div class="title">Rocket Planner</div>
        </div>
      </div>

      <div class="toolbar">
        </div>
    </div>

    <div class="workspace" id="workspaceRoot">
      <aside class="sidebar" id="sidebar">
        <div>
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px"><div style="font-weight:700">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</div><div class="muted" id="majCount">0</div></div>
          <div id="majorList" style="display:flex;flex-direction:column;gap:8px;max-height:520px;overflow:auto"></div>
          <div style="margin-top:12px;display:flex;gap:8px"><input id="newMajor" placeholder="æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ" style="flex:1;min-width:0" /><button id="addMajor" class="pill">è¿½åŠ </button></div>
        </div>

        </aside>

      <main class="content" id="contentRoot">
        
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
            <div class="search-box" id="searchBox" style="flex: 1;">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M11 18a7 7 0 100-14 7 7 0 000 14z"/></svg>
              <input id="globalSearch" style="border:0;background:transparent;outline:none;min-width:0;flex:1" placeholder="å°ç›®æ¨™ã‚’æ¤œç´¢" />
            </div>

            <div class="filters" style="display: flex; align-items: center; gap: 10px; margin-left: 20px;">
                <div class="muted" style="white-space: nowrap;">ãƒ•ã‚£ãƒ«ã‚¿:</div>
                <select id="filterPriority" style="padding:8px; border:1px solid rgba(2,6,23,0.04); border-radius:8px; min-width: 100px;">
                    <option value="All">å…¨éƒ¨</option><option>High</option><option>Medium</option><option>Low</option>
                </select>
                <label class="muted" style="display:flex;align-items:center;gap:6px; white-space: nowrap;"><input type="checkbox" id="showDone" checked/> å®Œäº†</label>
            </div>
        </div>

        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <div id="activeTitleContainer" aria-hidden="true"><h2 id="activeTitle">å¤§ç›®æ¨™ã‚’é¸æŠã—ã¦ãã ã•ã„</h2></div>
        </div>

        <div id="noteArea" style="flex:1;min-width:0;margin-bottom:20px;"> <div id="noteGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;min-width:0"></div>
        </div>

        <div style="margin-top:16px" id="emptyHint" class="muted">å°ç›®æ¨™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚è¿½åŠ ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</div>
        
        <div style="display:flex;align-items:center;justify-content:flex-end;margin-top:12px;">
            <div class="add-box" style="min-width:0;max-width:820px;flex:1">
              <input id="noteTitle" placeholder="å°ç›®æ¨™ã‚¿ã‚¤ãƒˆãƒ«" style="flex:1;min-width:0;padding:10px;border:1px solid rgba(2,6,23,0.04);border-radius:8px" />
              <input id="noteEnd" type="date" style="padding:8px;border:1px solid rgba(2,6,23,0.04);border-radius:8px" />
              <select id="notePriority" style="padding:8px;border:1px solid rgba(2,6,23,0.04);border-radius:8px"><option>Medium</option><option>High</option><option>Low</option></select>
              <button id="addNote" class="pill">è¿½åŠ </button>
            </div>
        </div>

      </main>

      <aside class="inspector" id="inspector">
        <div style="display:flex;align-items:center;margin-bottom:8px"><div style="font-weight:700">ã‚¤ãƒ³ã‚¹ãƒšã‚¯ã‚¿</div></div>
        <div id="inspectorArea" class="card muted">ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      </aside>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'planit_simple_v1';
    const uid = (p='id')=> p+'_'+Math.random().toString(36).slice(2,9);
    
    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾— (YYYY-MM-DDå½¢å¼)
    const today = new Date().toISOString().split('T')[0];

    const SAMPLE = {
      majors: [
        { id: uid('maj'), title: 'å­¦ç¿’ã§ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—', bullets: ['JSåŸºç¤ã‚’å®Œäº†ã™ã‚‹','Reactã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ'], notes: [ { id: uid('n'), title: 'JSåŸºç¤ã‚’å®Œäº†', body:'é–¢æ•°ã¨éåŒæœŸã‚’å¾©ç¿’', priority:'High', start:'2025-10-01', end:'2025-10-10', difficulty:'ä¸­', done:false } ] },
        { id: uid('maj'), title: 'å¥åº·ç¿’æ…£', bullets: ['æ¯æœ30åˆ†æ•£æ­©'], notes: [ { id: uid('n'), title:'æœã®æ•£æ­©', body:'é€±4å›å®Ÿæ–½', priority:'Low', start:'2025-10-01', end:'2025-12-31', difficulty:'ä½', done:false } ] }
      ]
    };

    function load(){ try{ const raw = localStorage.getItem(STORAGE_KEY); return raw? JSON.parse(raw):SAMPLE }catch(e){ return SAMPLE } }
    function save(d){ localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }

    let data = load();
    let activeMajorId = data.majors[0]?.id || null;
    let selectedNoteId = null;

    const majorList = document.getElementById('majorList');
    const majCount = document.getElementById('majCount');
    const activeTitle = document.getElementById('activeTitle');
    const newMajor = document.getElementById('newMajor');
    const addMajor = document.getElementById('addMajor');
    const noteGrid = document.getElementById('noteGrid');
    const emptyHint = document.getElementById('emptyHint');
    const noteTitle = document.getElementById('noteTitle');
    const noteEnd = document.getElementById('noteEnd');
    const notePriority = document.getElementById('notePriority');
    const addNote = document.getElementById('addNote');
    const inspectorArea = document.getElementById('inspectorArea');
    const filterPriority = document.getElementById('filterPriority');
    const showDone = document.getElementById('showDone');
    const globalSearch = document.getElementById('globalSearch');
    
    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å°ç›®æ¨™ãŒå…¨ã¦å®Œäº†ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
    function isMajorDone(major){
        return major.notes.length > 0 && major.notes.every(n => n.done);
    }


    function renderMajors(){ 
      majorList.innerHTML=''; 
      if(data.majors.length===0){ 
        const t = document.createElement('div'); 
        t.className='muted'; 
        t.innerText='ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ–°ã—ãä½œæˆã—ã¦ãã ã•ã„ã€‚'; 
        majorList.appendChild(t); 
        majCount.innerText = 0; 
        return 
      } 
      
      data.majors.forEach(m=>{ 
        const el = document.createElement('div'); 
        
        // å®Œäº†çŠ¶æ…‹ã®ãƒã‚§ãƒƒã‚¯ã¨ã‚¯ãƒ©ã‚¹è¿½åŠ 
        const isDone = isMajorDone(m);
        el.className = 'sb-item ' + (m.id===activeMajorId? 'active':'') + (isDone ? ' done' : '');
        
        el.innerHTML = `<div style="flex:1;min-width:0"><div class="project-title" style="font-weight:600">${escape(m.title)}</div><div class="project-sub muted">${m.notes.length} ä»¶</div></div><div style="font-size:12px;color:#ef4444;cursor:pointer;margin-left:8px">Ã—</div>`; 
        el.addEventListener('click',(e)=>{ 
          if(e.target && e.target.innerText==='Ã—'){ 
            if(!confirm('ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return; 
            data.majors = data.majors.filter(x=>x.id!==m.id); 
            if(activeMajorId===m.id) activeMajorId = data.majors[0]?.id || null; 
            save(data); 
            renderAll(); 
            return 
          } 
          activeMajorId = m.id; selectedNoteId = null; renderAll(); 
        }); 
        majorList.appendChild(el); 
      }); 
      majCount.innerText = data.majors.length; 
    }

    function renderNotes(){ 
      noteGrid.innerHTML=''; 
      const major = data.majors.find(x=>x.id===activeMajorId); 
      if(activeTitle) activeTitle.innerText = major? major.title: 'å¤§ç›®æ¨™ã‚’é¸æŠã—ã¦ãã ã•ã„'; 
      
      // å°ç›®æ¨™ãŒãªã„å ´åˆã¯ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤ºã—ã¦çµ‚äº†
      if(!major || major.notes.length===0){ 
        emptyHint.style.display='block'; 
        return 
      } 
      emptyHint.style.display='none'; 
      
      const q = (globalSearch && globalSearch.value)? globalSearch.value.trim().toLowerCase() : ''; 
      const fp = filterPriority.value; 
      const sd = showDone.checked; 
      
      const filtered = major.notes.filter(n=>{ 
        if(!sd && n.done) return false; 
        if(fp!=='All' && n.priority !== fp) return false; 
        if(q && !(n.title + ' ' + (n.body||'')).toLowerCase().includes(q)) return false; 
        return true; 
      });
      
      filtered.forEach(n=>{ 
        const c = document.createElement('div'); 
        
        // æœŸé™åˆ‡ã‚Œãƒã‚§ãƒƒã‚¯
        const isMissedDeadline = n.end && !n.done && n.end < today;
        // å®Œäº†ãƒã‚§ãƒƒã‚¯
        const isDone = n.done; 
        
        // ã‚¯ãƒ©ã‚¹åã‚’æ§‹ç¯‰
        let cardClasses = 'card';
        if (isMissedDeadline) {
            cardClasses += ' missed-deadline';
        }
        if (isDone) {
            cardClasses += ' done-card'; // å®Œäº†æ™‚ã«ã“ã®ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
        }
        
        c.className = cardClasses; 
        c.style.cursor='pointer'; 
        
        // å®Œäº†ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ±ºå®š
        const doneButtonClass = n.done ? 'done-button' : 'not-done-button';
        
        c.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:flex-start">
            <div style="font-weight:700;min-width:0">${escape(n.title)}</div>
            <div style="text-align:right">
              <div class="muted" style="font-size:12px">${n.difficulty||'-'}</div>
              <div style="margin-top:8px">${badge(n.priority)}</div>
            </div>
          </div>
          <div class="muted" style="margin-top:8px">${escape(n.body||'ï¼ˆèª¬æ˜ã‚’è¿½åŠ ï¼‰')}</div>
          <div style="display:flex;justify-content:space-between;margin-top:12px">
            <div class="muted" style="font-size:12px">${n.end ? (n.end) : 'æ—¥ä»˜ãªã—'}</div>
            <div class="card-actions">
              <button class="pill small toggle-done ${doneButtonClass}">${n.done? 'å®Œäº†æ¸ˆ':'å®Œäº†'}</button> 
              <button class="pill small delete-note" style="color:#ef4444">å‰Šé™¤</button>
            </div>
          </div>
        `;

        c.addEventListener('click',(e)=>{ 
          const tgt = e.target; 
          
          if(tgt && tgt.classList.contains('delete-note')){
            if(!confirm('ã“ã®å°ç›®æ¨™ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return; 
            major.notes = major.notes.filter(x=>x.id!==n.id); 
            save(data); 
            selectedNoteId = null; 
            renderAll(); 
            return 
          } 
          
          if(tgt && tgt.classList.contains('toggle-done')){
            n.done = !n.done; 
            save(data); 
            renderAll(); 
            return 
          } 
          
          // ã‚«ãƒ¼ãƒ‰æœ¬ä½“ã‚¯ãƒªãƒƒã‚¯ã§ã‚¤ãƒ³ã‚¹ãƒšã‚¯ã‚¿è¡¨ç¤ºï¼ˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã¯é™¤ãï¼‰
          if(tgt.closest('.card') === c && !tgt.classList.contains('pill')) {
            selectedNoteId = n.id; 
            renderInspector(); 
          }
        }); 
        noteGrid.appendChild(c); 
      }); 
    }

    function renderInspector(){ 
      const all = data.majors.flatMap(m=> m.notes.map(n=> ({...n, majorTitle:m.title, majorId:m.id}))); 
      const note = all.find(x=>x.id===selectedNoteId); 
      
      if(!note){ 
        inspectorArea.classList.add('muted'); 
        inspectorArea.innerText = 'ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„'; 
        return 
      } 
      
      inspectorArea.classList.remove('muted'); 
      inspectorArea.innerHTML = `<div><div style="font-weight:700;margin-bottom:6px">${escape(note.title)}</div><div class="muted" style="font-size:13px;margin-bottom:8px">${escape(note.majorTitle)}</div><textarea id="insBody" class="ins-textarea">${escape(note.body||'')}</textarea><div style="display:flex;gap:8px;margin-top:8px"><input id="insEnd" type="date" value="${note.end||''}" style="padding:8px;border:1px solid rgba(2,6,23,0.04);border-radius:8px" /><select id="insPriority" style="padding:8px;border:1px solid rgba(2,6,23,0.04);border-radius:8px"><option>High</option><option>Medium</option><option>Low</option></select></div><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button id="insSave" class="pill">ä¿å­˜</button><button id="insDelete" class="pill" style="color:#ef4444">å‰Šé™¤</button></div></div>`; 
      
      document.getElementById('insPriority').value = note.priority || 'Medium'; 
      
      document.getElementById('insSave').addEventListener('click', ()=>{ 
        note.body = document.getElementById('insBody').value; 
        note.end = document.getElementById('insEnd').value; 
        note.priority = document.getElementById('insPriority').value; 
        data.majors = data.majors.map(m=> ({ ...m, notes: m.notes.map(n=> n.id===note.id? note:n) })); 
        save(data); 
        renderAll(); 
      }); 
      
      document.getElementById('insDelete').addEventListener('click', ()=>{ 
        if(!confirm('ã“ã®å°ç›®æ¨™ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return; 
        data.majors = data.majors.map(m=> ({ ...m, notes: m.notes.filter(n=> n.id!==note.id) })); 
        save(data); 
        selectedNoteId = null; 
        renderAll(); 
      }); 
    }

    function renderAll(){ 
      renderMajors(); 
      renderNotes(); 
      renderInspector(); 
    }

    function badge(p){ 
      if(p==='High') return '<span class="badge badge-high">High</span>'; 
      if(p==='Medium') return '<span class="badge badge-med">Med</span>'; 
      return '<span class="badge badge-low">Low</span>'; 
    }
    
    function escape(s){ 
      if(!s) return ''; 
      return String(s).replace(/[&<>"'`]/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;','`':'&#96;'}[c]||c)); 
    }

    addMajor.addEventListener('click', ()=>{ 
      const t=newMajor.value.trim(); 
      if(!t) return; 
      const m={ id:uid('maj'), title:t, bullets:[], notes:[] }; 
      data.majors.push(m); 
      newMajor.value=''; 
      save(data); 
      activeMajorId = m.id; 
      renderAll(); 
    });
    
    addNote.addEventListener('click', ()=>{ 
      const title=noteTitle.value.trim(); 
      if(!title) return; 
      const major = data.majors.find(x=> x.id===activeMajorId); 
      if(!major) return alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸ã‚“ã§ãã ã•ã„'); 
      const n={ id:uid('n'), title, body:'', priority:notePriority.value, end:noteEnd.value, difficulty:'ä¸­', done:false }; 
      major.notes.unshift(n); 
      noteTitle.value=''; 
      noteEnd.value=''; 
      save(data); 
      selectedNoteId = n.id; 
      renderAll(); 
    });

    filterPriority.addEventListener('change', ()=> renderNotes()); 
    showDone.addEventListener('change', ()=> renderNotes()); 
    globalSearch.addEventListener('input', ()=> renderNotes());

    renderAll();
  </script>
</body>
</html>