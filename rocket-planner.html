<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rocket Planner — シンプルワイドUI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg:#ffffff; --muted:#6b7280; --accent:#2563eb; --card:#ffffff;
      --sidebar-w:260px; --inspector-w:320px;
      --border: rgba(2,6,23,0.10);
      /* 完了したプロジェクトの色 */
      --project-done-bg: #ecfdf5; /* 薄い緑の背景 */
      --project-done-text: #065f46; /* 濃い緑の文字 */
      /* 期限切れのカードの色 */
      --deadline-missed-border: #f87171; /* 赤い枠 */
      --deadline-missed-shadow: rgba(248, 113, 113, 0.2); /* 赤い影 */
      /* 新しいロゴの色 */
      --logo-color-start: #a855f7; /* VIOLET-600 */
      --logo-color-end: #ec4899; /* PINK-500 */
    }
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;margin:24px;background:var(--bg);}

    .app{width:calc(100% - 96px);max-width:1400px;margin:0 auto;border-radius:12px;background:linear-gradient(180deg,#ffffff,#ffffff);box-shadow:0 24px 48px rgba(2,6,23,0.06);overflow:hidden;border:1px solid var(--border)}

    /* 横書きを強制（縦組み防止） */
    html, body, .app, .workspace, .sidebar, .content, .inspector, .card, .message, .sb-item, .project-title, .project-sub, .title, h2, input, textarea, select, button {
      writing-mode: horizontal-tb !important;
      -webkit-writing-mode: horizontal-tb !important;
      text-orientation: mixed !important;
      -webkit-text-orientation: mixed !important;
    }

    .titlebar{height:56px;display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-bottom:1px solid var(--border);}
    .brand{display:flex;align-items:center;gap:14px}
    
    /* 🚀新しいロゴスタイル */
    .logo{
        width:36px;height:36px;border-radius:8px;
        background:linear-gradient(135deg, var(--logo-color-start), var(--logo-color-end));
        display:flex;align-items:center;justify-content:center;
        color:white;font-size:20px;
    }
    .title{font-weight:700}

    .toolbar{display:flex;align-items:center;gap:8px}

    /* content に flex-direction: column を追加して、下部に配置しやすくする */
    .workspace{display:flex;min-height:680px}
    .sidebar{width:var(--sidebar-w);padding:20px;border-right:1px solid var(--border);background:transparent;min-width:0;display:flex;flex-direction:column}
    .content{flex:1;padding:24px;min-width:0; display:flex; flex-direction:column; }
    .inspector{width:var(--inspector-w);padding:20px;border-left:1px solid var(--border);background:transparent;min-width:0}

    .sb-item{display:flex;align-items:center;gap:10px;padding:12px;border-radius:10px;cursor:pointer;min-width:0}
    .sb-item:hover{background:rgba(2,6,23,0.03)}
    .sb-item.active{background:linear-gradient(90deg, rgba(99,102,241,0.06), rgba(99,102,241,0.02));}

    .sb-item .project-title{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block;min-width:0}
    .sb-item .project-sub{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:12px;color:var(--muted)}
    
    /* プロジェクト完了時のスタイル (項目全体の色変更) */
    .sb-item.done {
      background: var(--project-done-bg); /* 背景色 */
    }
    .sb-item.done .project-title{
      color: var(--project-done-text); /* 文字色 */
      font-weight: 700;
    }

    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 14px 36px rgba(2,6,23,0.06);border:1px solid rgba(2,6,23,0.06);min-width:0}
    
    /* 期限切れのカードスタイル */
    .card.missed-deadline {
      border: 2px solid var(--deadline-missed-border); /* 枠を赤く */
      box-shadow: 0 14px 36px var(--deadline-missed-shadow); /* 影を赤っぽく */
    }
    
    /* 🚀 完了したカードのスタイル (文字色含む全体変更) */
    .card.done-card {
        background: #f0fdf4; /* 薄い緑の背景 */
        border: 1px solid #34d399; /* 緑の枠線 */
        opacity: 1.0;
        color: #166534; /* カード全体の標準文字色を濃い緑に設定 */
    }
    /* 完了したカード内の muted な要素も緑色に調整 */
    .card.done-card .muted {
        color: #34d399 !important;
    }
    /* 完了したカード内の完了ボタンの色は元々濃い緑なので維持 */

    .muted{color:var(--muted)}
    .pill{padding:8px 12px;border-radius:999px;background:rgba(2,6,23,0.04);font-weight:600}
    .badge{font-weight:700;padding:6px 10px;border-radius:999px;font-size:12px}
    .badge-high{background:#fee2e2;color:#7f1d1d}
    .badge-med{background:#fffbeb;color:#92400e}
    .badge-low{background:#f0fdf4;color:#166534}

    /* .sidebar .filters{margin-top:auto} は削除（メインコンテンツに移動したため） */

    /* 小目標追加エリアの境界 */
    .add-box{border:1px solid var(--border);border-radius:10px;padding:12px;background:linear-gradient(180deg,#ffffff,#fcfcff);box-shadow:0 6px 18px rgba(2,6,23,0.03);display:flex;align-items:center;gap:10px}

    /* 検索ボックスのスタイルと配置調整 */
    .search-box{
        margin-bottom:0; /* 親要素でマージンを調整 */
        margin-top:0;
        border:1px solid rgba(2,6,23,0.04);padding:8px;border-radius:8px;
        display:flex;align-items:center;gap:8px;min-width:0
    }

    /* インスペクタの説明編集欄を目立たせる */
    .ins-textarea{width:100%;height:110px;padding:12px;border-radius:8px;border:1px solid var(--border);background:#fff;box-shadow:inset 0 1px 3px rgba(2,6,23,0.02);resize:vertical}

    /* カード内の短い説明編集（もし将来入れる場合）の枠 */
    .card-desc-edit{padding:10px;border-radius:8px;border:1px dashed rgba(2,6,23,0.06);background:rgba(250,250,250,0.6)}

    h2{margin:0 0 6px 0}

    /* 完了ボタンのスタイル */
    .pill.done-button{
        background:#d1fae5; 
        color:#065f46; 
        font-weight:700;
    }
    .pill.not-done-button{
        background:rgba(2,6,23,0.04); 
        color:#374151; /* 文字を濃く修正 */
        font-weight:600;
    }
    
    /* カード内のボタンを同じ行に維持する flex コンテナ */
    .card-actions {
        display: flex;
        align-items: center;
        gap: 6px; /* ボタン間の間隔を調整 */
    }


    @media (max-width:1200px){ .app{width:calc(100% - 32px)} .inspector{display:none} }
  </style>
</head>
<body>
  <div class="app" id="appRoot">
    <div class="titlebar">
      <div class="brand">
        <div class="logo">🚀</div>
        <div>
          <div class="title">Rocket Planner</div>
        </div>
      </div>

      <div class="toolbar">
        </div>
    </div>

    <div class="workspace" id="workspaceRoot">
      <aside class="sidebar" id="sidebar">
        <div>
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px"><div style="font-weight:700">プロジェクト</div><div class="muted" id="majCount">0</div></div>
          <div id="majorList" style="display:flex;flex-direction:column;gap:8px;max-height:520px;overflow:auto"></div>
          <div style="margin-top:12px;display:flex;gap:8px"><input id="newMajor" placeholder="新しいプロジェクト" style="flex:1;min-width:0" /><button id="addMajor" class="pill">追加</button></div>
        </div>

        </aside>

      <main class="content" id="contentRoot">
        
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
            <div class="search-box" id="searchBox" style="flex: 1;">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M11 18a7 7 0 100-14 7 7 0 000 14z"/></svg>
              <input id="globalSearch" style="border:0;background:transparent;outline:none;min-width:0;flex:1" placeholder="小目標を検索" />
            </div>

            <div class="filters" style="display: flex; align-items: center; gap: 10px; margin-left: 20px;">
                <div class="muted" style="white-space: nowrap;">フィルタ:</div>
                <select id="filterPriority" style="padding:8px; border:1px solid rgba(2,6,23,0.04); border-radius:8px; min-width: 100px;">
                    <option value="All">全部</option><option>High</option><option>Medium</option><option>Low</option>
                </select>
                <label class="muted" style="display:flex;align-items:center;gap:6px; white-space: nowrap;"><input type="checkbox" id="showDone" checked/> 完了</label>
            </div>
        </div>

        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <div id="activeTitleContainer" aria-hidden="true"><h2 id="activeTitle">大目標を選択してください</h2></div>
        </div>

        <div id="noteArea" style="flex:1;min-width:0;margin-bottom:20px;"> <div id="noteGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;min-width:0"></div>
        </div>

        <div style="margin-top:16px" id="emptyHint" class="muted">小目標がありません。追加してみましょう。</div>
        
        <div style="display:flex;align-items:center;justify-content:flex-end;margin-top:12px;">
            <div class="add-box" style="min-width:0;max-width:820px;flex:1">
              <input id="noteTitle" placeholder="小目標タイトル" style="flex:1;min-width:0;padding:10px;border:1px solid rgba(2,6,23,0.04);border-radius:8px" />
              <input id="noteEnd" type="date" style="padding:8px;border:1px solid rgba(2,6,23,0.04);border-radius:8px" />
              <select id="notePriority" style="padding:8px;border:1px solid rgba(2,6,23,0.04);border-radius:8px"><option>Medium</option><option>High</option><option>Low</option></select>
              <button id="addNote" class="pill">追加</button>
            </div>
        </div>

      </main>

      <aside class="inspector" id="inspector">
        <div style="display:flex;align-items:center;margin-bottom:8px"><div style="font-weight:700">インスペクタ</div></div>
        <div id="inspectorArea" class="card muted">カードを選択してください</div>
      </aside>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'planit_simple_v1';
    const uid = (p='id')=> p+'_'+Math.random().toString(36).slice(2,9);
    
    // 今日の日付を取得 (YYYY-MM-DD形式)
    const today = new Date().toISOString().split('T')[0];

    const SAMPLE = {
      majors: [
        { id: uid('maj'), title: '学習でスキルアップ', bullets: ['JS基礎を完了する','Reactでプロジェクト作成'], notes: [ { id: uid('n'), title: 'JS基礎を完了', body:'関数と非同期を復習', priority:'High', start:'2025-10-01', end:'2025-10-10', difficulty:'中', done:false } ] },
        { id: uid('maj'), title: '健康習慣', bullets: ['毎朝30分散歩'], notes: [ { id: uid('n'), title:'朝の散歩', body:'週4回実施', priority:'Low', start:'2025-10-01', end:'2025-12-31', difficulty:'低', done:false } ] }
      ]
    };

    function load(){ try{ const raw = localStorage.getItem(STORAGE_KEY); return raw? JSON.parse(raw):SAMPLE }catch(e){ return SAMPLE } }
    function save(d){ localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }

    let data = load();
    let activeMajorId = data.majors[0]?.id || null;
    let selectedNoteId = null;

    const majorList = document.getElementById('majorList');
    const majCount = document.getElementById('majCount');
    const activeTitle = document.getElementById('activeTitle');
    const newMajor = document.getElementById('newMajor');
    const addMajor = document.getElementById('addMajor');
    const noteGrid = document.getElementById('noteGrid');
    const emptyHint = document.getElementById('emptyHint');
    const noteTitle = document.getElementById('noteTitle');
    const noteEnd = document.getElementById('noteEnd');
    const notePriority = document.getElementById('notePriority');
    const addNote = document.getElementById('addNote');
    const inspectorArea = document.getElementById('inspectorArea');
    const filterPriority = document.getElementById('filterPriority');
    const showDone = document.getElementById('showDone');
    const globalSearch = document.getElementById('globalSearch');
    
    // プロジェクトの小目標が全て完了しているかチェックする関数
    function isMajorDone(major){
        return major.notes.length > 0 && major.notes.every(n => n.done);
    }


    function renderMajors(){ 
      majorList.innerHTML=''; 
      if(data.majors.length===0){ 
        const t = document.createElement('div'); 
        t.className='muted'; 
        t.innerText='プロジェクトがありません。新しく作成してください。'; 
        majorList.appendChild(t); 
        majCount.innerText = 0; 
        return 
      } 
      
      data.majors.forEach(m=>{ 
        const el = document.createElement('div'); 
        
        // 完了状態のチェックとクラス追加
        const isDone = isMajorDone(m);
        el.className = 'sb-item ' + (m.id===activeMajorId? 'active':'') + (isDone ? ' done' : '');
        
        el.innerHTML = `<div style="flex:1;min-width:0"><div class="project-title" style="font-weight:600">${escape(m.title)}</div><div class="project-sub muted">${m.notes.length} 件</div></div><div style="font-size:12px;color:#ef4444;cursor:pointer;margin-left:8px">×</div>`; 
        el.addEventListener('click',(e)=>{ 
          if(e.target && e.target.innerText==='×'){ 
            if(!confirm('このプロジェクトを削除しますか？')) return; 
            data.majors = data.majors.filter(x=>x.id!==m.id); 
            if(activeMajorId===m.id) activeMajorId = data.majors[0]?.id || null; 
            save(data); 
            renderAll(); 
            return 
          } 
          activeMajorId = m.id; selectedNoteId = null; renderAll(); 
        }); 
        majorList.appendChild(el); 
      }); 
      majCount.innerText = data.majors.length; 
    }

    function renderNotes(){ 
      noteGrid.innerHTML=''; 
      const major = data.majors.find(x=>x.id===activeMajorId); 
      if(activeTitle) activeTitle.innerText = major? major.title: '大目標を選択してください'; 
      
      // 小目標がない場合はヒントを表示して終了
      if(!major || major.notes.length===0){ 
        emptyHint.style.display='block'; 
        return 
      } 
      emptyHint.style.display='none'; 
      
      const q = (globalSearch && globalSearch.value)? globalSearch.value.trim().toLowerCase() : ''; 
      const fp = filterPriority.value; 
      const sd = showDone.checked; 
      
      const filtered = major.notes.filter(n=>{ 
        if(!sd && n.done) return false; 
        if(fp!=='All' && n.priority !== fp) return false; 
        if(q && !(n.title + ' ' + (n.body||'')).toLowerCase().includes(q)) return false; 
        return true; 
      });
      
      filtered.forEach(n=>{ 
        const c = document.createElement('div'); 
        
        // 期限切れチェック
        const isMissedDeadline = n.end && !n.done && n.end < today;
        // 完了チェック
        const isDone = n.done; 
        
        // クラス名を構築
        let cardClasses = 'card';
        if (isMissedDeadline) {
            cardClasses += ' missed-deadline';
        }
        if (isDone) {
            cardClasses += ' done-card'; // 完了時にこのクラスを追加
        }
        
        c.className = cardClasses; 
        c.style.cursor='pointer'; 
        
        // 完了ボタンのスタイルを決定
        const doneButtonClass = n.done ? 'done-button' : 'not-done-button';
        
        c.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:flex-start">
            <div style="font-weight:700;min-width:0">${escape(n.title)}</div>
            <div style="text-align:right">
              <div class="muted" style="font-size:12px">${n.difficulty||'-'}</div>
              <div style="margin-top:8px">${badge(n.priority)}</div>
            </div>
          </div>
          <div class="muted" style="margin-top:8px">${escape(n.body||'（説明を追加）')}</div>
          <div style="display:flex;justify-content:space-between;margin-top:12px">
            <div class="muted" style="font-size:12px">${n.end ? (n.end) : '日付なし'}</div>
            <div class="card-actions">
              <button class="pill small toggle-done ${doneButtonClass}">${n.done? '完了済':'完了'}</button> 
              <button class="pill small delete-note" style="color:#ef4444">削除</button>
            </div>
          </div>
        `;

        c.addEventListener('click',(e)=>{ 
          const tgt = e.target; 
          
          if(tgt && tgt.classList.contains('delete-note')){
            if(!confirm('この小目標を削除しますか？')) return; 
            major.notes = major.notes.filter(x=>x.id!==n.id); 
            save(data); 
            selectedNoteId = null; 
            renderAll(); 
            return 
          } 
          
          if(tgt && tgt.classList.contains('toggle-done')){
            n.done = !n.done; 
            save(data); 
            renderAll(); 
            return 
          } 
          
          // カード本体クリックでインスペクタ表示（ボタンクリック時は除く）
          if(tgt.closest('.card') === c && !tgt.classList.contains('pill')) {
            selectedNoteId = n.id; 
            renderInspector(); 
          }
        }); 
        noteGrid.appendChild(c); 
      }); 
    }

    function renderInspector(){ 
      const all = data.majors.flatMap(m=> m.notes.map(n=> ({...n, majorTitle:m.title, majorId:m.id}))); 
      const note = all.find(x=>x.id===selectedNoteId); 
      
      if(!note){ 
        inspectorArea.classList.add('muted'); 
        inspectorArea.innerText = 'カードを選択してください'; 
        return 
      } 
      
      inspectorArea.classList.remove('muted'); 
      inspectorArea.innerHTML = `<div><div style="font-weight:700;margin-bottom:6px">${escape(note.title)}</div><div class="muted" style="font-size:13px;margin-bottom:8px">${escape(note.majorTitle)}</div><textarea id="insBody" class="ins-textarea">${escape(note.body||'')}</textarea><div style="display:flex;gap:8px;margin-top:8px"><input id="insEnd" type="date" value="${note.end||''}" style="padding:8px;border:1px solid rgba(2,6,23,0.04);border-radius:8px" /><select id="insPriority" style="padding:8px;border:1px solid rgba(2,6,23,0.04);border-radius:8px"><option>High</option><option>Medium</option><option>Low</option></select></div><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button id="insSave" class="pill">保存</button><button id="insDelete" class="pill" style="color:#ef4444">削除</button></div></div>`; 
      
      document.getElementById('insPriority').value = note.priority || 'Medium'; 
      
      document.getElementById('insSave').addEventListener('click', ()=>{ 
        note.body = document.getElementById('insBody').value; 
        note.end = document.getElementById('insEnd').value; 
        note.priority = document.getElementById('insPriority').value; 
        data.majors = data.majors.map(m=> ({ ...m, notes: m.notes.map(n=> n.id===note.id? note:n) })); 
        save(data); 
        renderAll(); 
      }); 
      
      document.getElementById('insDelete').addEventListener('click', ()=>{ 
        if(!confirm('この小目標を削除しますか？')) return; 
        data.majors = data.majors.map(m=> ({ ...m, notes: m.notes.filter(n=> n.id!==note.id) })); 
        save(data); 
        selectedNoteId = null; 
        renderAll(); 
      }); 
    }

    function renderAll(){ 
      renderMajors(); 
      renderNotes(); 
      renderInspector(); 
    }

    function badge(p){ 
      if(p==='High') return '<span class="badge badge-high">High</span>'; 
      if(p==='Medium') return '<span class="badge badge-med">Med</span>'; 
      return '<span class="badge badge-low">Low</span>'; 
    }
    
    function escape(s){ 
      if(!s) return ''; 
      return String(s).replace(/[&<>"'`]/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;','`':'&#96;'}[c]||c)); 
    }

    addMajor.addEventListener('click', ()=>{ 
      const t=newMajor.value.trim(); 
      if(!t) return; 
      const m={ id:uid('maj'), title:t, bullets:[], notes:[] }; 
      data.majors.push(m); 
      newMajor.value=''; 
      save(data); 
      activeMajorId = m.id; 
      renderAll(); 
    });
    
    addNote.addEventListener('click', ()=>{ 
      const title=noteTitle.value.trim(); 
      if(!title) return; 
      const major = data.majors.find(x=> x.id===activeMajorId); 
      if(!major) return alert('プロジェクトを選んでください'); 
      const n={ id:uid('n'), title, body:'', priority:notePriority.value, end:noteEnd.value, difficulty:'中', done:false }; 
      major.notes.unshift(n); 
      noteTitle.value=''; 
      noteEnd.value=''; 
      save(data); 
      selectedNoteId = n.id; 
      renderAll(); 
    });

    filterPriority.addEventListener('change', ()=> renderNotes()); 
    showDone.addEventListener('change', ()=> renderNotes()); 
    globalSearch.addEventListener('input', ()=> renderNotes());

    renderAll();
  </script>
</body>
</html>